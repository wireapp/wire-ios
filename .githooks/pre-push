#!/bin/bash

#
# Wire
# Copyright (C) 2018 Wire Swiss GmbH
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program. If not, see http://www.gnu.org/licenses/.
#

# Check if SwiftLint is installed
if ! command -v swiftlint &> /dev/null; then
    echo "Error: SwiftLint is not installed."
    echo "Please install SwiftLint by following the instructions at:"
    echo "https://github.com/realm/SwiftLint#installation"
    echo "Push aborted."
    exit 1
fi

# Get the branch name and the commit hash of the previous push
PREVIOUS_BRANCH=$(git rev-parse --abbrev-ref HEAD@{1})
PREVIOUS_COMMIT=$(git rev-parse HEAD@{1})

# Run SwiftLint on the files that have changed since the last push
SWIFTLINT_OUTPUT=$(git diff --name-only $PREVIOUS_COMMIT..HEAD | grep -E '\.(swift)$' | xargs swiftlint lint --quiet)

# Check if SwiftLint found any issues
if [ -n "$SWIFTLINT_OUTPUT" ]; then
    echo "SwiftLint found issues in the following files:"
    echo "$SWIFTLINT_OUTPUT"
    echo "Auto-fixing SwiftLint issues..."

    # Auto-fix any fixable issues using SwiftLint
    git diff --name-only $PREVIOUS_COMMIT..HEAD | grep -E '\.(swift)$' | xargs swiftlint --fix

    # Stage the changes made by SwiftLint for commit
    git add .

    # Commit the changes with a temporary message for review
    git commit -m "SwiftLint auto-fixes" --no-verify

    echo "Verify the commit and push again."
    exit 1
fi
