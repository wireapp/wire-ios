on:
  workflow_call:
    inputs:
      folders:
        type: string
      all:
        type: boolean
        default: false
        required: false
    secrets:
      ZENKINS_USERNAME:
        required: true
      DD_API_KEY:
        required: true

env: # https://docs.fastlane.tools/getting-started/ios/setup/
  LC_ALL: en_US.UTF-8
  LANG: en_US.UTF-8

jobs:
  run-tests:
    runs-on: ghcr.io/cirruslabs/macos-runner:sonoma
    env:
      GITHUB_ACCESS_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      GITHUB_USERNAME: ${{ secrets.ZENKINS_USERNAME }}
      SLACK_WEBHOOK_URL: ${{ secrets.WIRE_IOS_CI_WEBHOOK }}

    steps:
      - uses: actions/checkout@v3

      - name: Retrieve Xcode version
        run: |
          echo "XCODE_VERSION=$(cat .xcode-version)" >> $GITHUB_OUTPUT
        id: xcode-version

      - uses: maxim-lobanov/setup-xcode@v1.5.1
        with:
          xcode-version: ${{ steps.xcode-version.outputs.XCODE_VERSION }}

      - name: Load .env file
        uses: xom9ikk/dotenv@v2
        with:
            path: fastlane/

      - name: Restore Carthage Cache
        uses: actions/cache@v3
        id: cache-carthage
        with:
          path: Carthage
          key: ${{ runner.os }}-xcode${{ steps.xcode-version.outputs.XCODE_VERSION }}-carthage-${{ hashFiles('Cartfile.resolved') }}

      - name: Bootstrap Carthage if no cache
        if: steps.cache-carthage.outputs.cache-hit != 'true'
        run: ./scripts/carthage.sh bootstrap --platform ios --use-xcframeworks

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          bundler-cache: true

      - name: Setup workspace
        run: |
          ./setup.sh

      - name: Setup simulator
        run: |
          bundle exec fastlane prepare_for_tests

  generate_framework_list:
    needs: run-tests
    runs-on: ghcr.io/cirruslabs/macos-sonoma-xcode:15.4
    outputs:
      frameworks: ${{ steps.set_frameworks.outputs.frameworks }}
    steps:
      - name: Set frameworks
        id: set_frameworks
        run: |
          // TODO passing folders from caller workflow to this job
          bundle exec fastlane generate_framework_list folders:${{ inputs.folders }}